var Miniflux={},DEBUG=!1;Miniflux.App=function(){return{Log:function(e){DEBUG&&console.log(e)},Run:function(){Miniflux.Event.ListenKeyboardEvents(),Miniflux.Event.ListenMouseEvents(),Miniflux.Event.ListenVisibilityEvents(),Miniflux.Event.ListenTouchEvents(),this.FrontendUpdateCheck(),document.addEventListener("DOMContentLoaded",Miniflux.Item.selectFirstItem(),!1)},FrontendUpdateCheck:function(){var e=new XMLHttpRequest;e.onload=function(){var e=JSON.parse(this.responseText);e.frontend_updatecheck_interval>0?(Miniflux.App.Log("Frontend updatecheck interval in minutes: "+e.frontend_updatecheck_interval),Miniflux.Item.CheckForUpdates(),setInterval(function(){Miniflux.Item.CheckForUpdates()},60*e.frontend_updatecheck_interval*1e3)):Miniflux.App.Log("Frontend updatecheck disabled")},e.open("POST","?action=get-config",!0),e.send(JSON.stringify(["frontend_updatecheck_interval"]))}}}(),Miniflux.Event=function(){function e(e){if(63!==e.keyCode&&63!==e.which&&(e.ctrlKey||e.altKey||e.metaKey))return!0;var t=e.target||e.srcElement;return"INPUT"===t.tagName||"TEXTAREA"===t.tagName}var t=[];return{lastEventType:"",ListenMouseEvents:function(){document.onclick=function(e){e.target.hasAttribute("data-action")&&"original"!==e.target.className&&e.preventDefault()},document.onmouseup=function(e){if(2!==e.button)if("INPUT"!==e.target.nodeName||"auto-select"!==e.target.className){var t=e.target.getAttribute("data-action");if(t){Miniflux.Event.lastEventType="mouse";var n=function(){for(var t=e.target;t&&t.parentNode;)if((t=t.parentNode).tagName&&"article"===t.tagName.toLowerCase())return t}();switch(t){case"refresh-all":Miniflux.Feed.UpdateAll(e.target.getAttribute("data-concurrent-requests"));break;case"refresh-feed":n&&Miniflux.Feed.Update(n);break;case"mark-read":n&&Miniflux.Item.MarkAsRead(n);break;case"mark-unread":n&&Miniflux.Item.MarkAsUnread(n);break;case"mark-removed":n&&Miniflux.Item.MarkAsRemoved(n);break;case"bookmark":n&&(Miniflux.Item.SwitchBookmark(n),Miniflux.Item.MarkAsRead(n));break;case"download-item":n&&Miniflux.Item.DownloadContent(n);break;case"mark-feed-read":var a=document.getElementById("listing").getAttribute("data-feed-id");Miniflux.Item.MarkFeedAsRead(a);break;case"close-help":Miniflux.Nav.CloseHelp();break;case"show-search":Miniflux.Nav.ShowSearch();break;case"toggle-menu-more":Miniflux.Nav.ToggleMenuMore()}}}else e.target.select()}},ListenKeyboardEvents:function(){document.onkeypress=function(n){if(!e(n))if(Miniflux.Event.lastEventType="keyboard",t.push(n.key||n.which),"g"===t[0]||103===t[0])switch(t[1]){case void 0:break;case"u":case 117:window.location.href="?action=unread",t=[];break;case"b":case 98:window.location.href="?action=bookmarks",t=[];break;case"h":case 104:window.location.href="?action=history",t=[];break;case"s":case 115:window.location.href="?action=feeds",t=[];break;case"p":case 112:window.location.href="?action=config",t=[];break;default:t=[]}else{t=[];var a=function(){return document.getElementById("current-item")}();switch(n.key||n.which){case"A":case 65:n.shiftKey&&(window.location.href="?action=mark-all-read");break;case"d":case 100:a&&Miniflux.Item.DownloadContent(a);break;case"p":case 112:case"k":case 107:Miniflux.Nav.SelectPreviousItem();break;case"n":case 110:case"j":case 106:Miniflux.Nav.SelectNextItem();break;case"v":case 118:a&&(Miniflux.Item.OpenOriginal(a),document.querySelectorAll("article.item")>1&&Miniflux.Nav.SelectNextItem());break;case"o":case 111:a&&Miniflux.Item.Show(a);break;case"m":case 109:a&&Miniflux.Item.SwitchStatus(a);break;case"f":case 102:a&&(Miniflux.Item.SwitchBookmark(a),Miniflux.Item.MarkAsRead(a));break;case"h":case 104:Miniflux.Nav.OpenPreviousPage();break;case"l":case 108:Miniflux.Nav.OpenNextPage();break;case"r":case 114:Miniflux.Feed.UpdateAll();break;case"?":case 63:Miniflux.Nav.ShowHelp();break;case"Q":case 81:case"q":case 113:Miniflux.Nav.CloseHelp();break;case"z":case 122:Miniflux.Item.ToggleRTLMode()}}},document.onkeydown=function(t){if(!e(t))switch(Miniflux.Event.lastEventType="keyboard",t.key||t.which){case"ArrowLeft":case"Left":case 37:Miniflux.Nav.SelectPreviousItem();break;case"ArrowRight":case"Right":case 39:Miniflux.Nav.SelectNextItem();break;case"/":case 191:t.preventDefault(),t.stopPropagation(),Miniflux.Nav.ShowSearch()}}},ListenVisibilityEvents:function(){document.addEventListener("visibilitychange",function(){Miniflux.App.Log("document.visibilityState: "+document.visibilityState),!document.hidden&&Miniflux.Item.hasNewUnread()&&(Miniflux.App.Log("Need to update the unread counter with fresh values from the database"),Miniflux.Item.CheckForUpdates())})},ListenTouchEvents:function(){var e=null,t=function(){e&&e.element&&(e.element.style.opacity=1,e.element.style.transform=""),e={touchstart:{x:-1,y:-1},touchmove:{x:-1,y:-1},touchend:!1,direction:"undetermined",swipestarted:!1,element:null}},n=function(){return e.touchstart.x>-1&&e.touchmove.x>-1&&(Math.abs(e.touchmove.x-e.touchstart.x)>30||e.swipestarted)&&Math.abs(e.touchmove.y-e.touchstart.y)<75?(e.swipestarted=!0,e.touchmove.x-e.touchstart.x):0},a=function(e,t){return e&&(t(e)?e:a(e.parentNode,t))},i=function(){return e.element?e.element:a(document.elementFromPoint(e.touchstart.x,e.touchstart.y),function(e){return"ARTICLE"===e.tagName})},r=function(){if(!e||!0!==e.touchend&&-1!=e.touchstart.x){null===e.element&&(e.element=i());var a=n();if(0!==a){var o=i();if(!o)return void t();var u=Math.abs(a);e.element.style.opacity=1-(u>75?.9:u/75*.9);var c=a>75?75:a<-75?-75:a;e.element.style.transform="translateX("+c+"px)",e.element=o}window.requestAnimationFrame(r)}},o=function(a){if(void 0!==a.touches&&a.touches.length<=1){Miniflux.Event.lastEventType="touch";var o=a.touches[0],u=null,c=null;switch(a.type){case"touchstart":t(),e[a.type].x=o.clientX,e[a.type].y=o.clientY,r();break;case"touchmove":e[a.type].x=o.clientX,e[a.type].y=o.clientY;break;case"touchend":e[a.type]=!0,c=i(),(u=n())>75||u<-75?(c&&Miniflux.Item.MarkAsRead(c),c.getAttribute("data-hide")||t()):t();break;case"touchcancel":t()}}else t()};t(),document.addEventListener("touchstart",o,!1),document.addEventListener("touchmove",o,!1),document.addEventListener("touchend",o,!1),document.addEventListener("touchcancel",o,!1)}}}(),Miniflux.Feed=function(){var e=[],t=5,n=null,a=[];return{Update:function(e,t){var n=e.querySelector("span.items-count");if(n){var a=e.getAttribute("data-feed-id"),i=e.querySelector("h2:first-of-type");i.className="loading-icon";var r=new XMLHttpRequest;r.onload=function(){i.className="",e.removeAttribute("data-feed-error");var a=e.querySelector(".feed-last-checked");a&&(a.innerHTML=a.getAttribute("data-after-update"));var r=JSON.parse(this.responseText);if(r.result)n.innerHTML=r.items_count.items_unread+"/"+r.items_count.items_total;else{e.setAttribute("data-feed-error","1");var o=e.querySelector(".feed-parsing-error");o&&(o.innerHTML=r.feed.parsing_error_message)}t?t(r):Miniflux.Item.CheckForUpdates()},r.open("POST","?action=refresh-feed&feed_id="+a,!0),r.send()}},UpdateAll:function(i){a=Array.prototype.slice.call(document.querySelectorAll("article:not([data-feed-disabled])")),i&&(t=i),n=setInterval(function(){for(;a.length>0&&e.length<t;){var n=a.shift();e.push(parseInt(n.getAttribute("data-feed-id"),10)),Miniflux.Feed.Update(n,Miniflux.Feed.OnFeedUpdated)}},100)},OnFeedUpdated:function(t){var i=e.indexOf(t.feed_id);i>=0&&e.splice(i,1),0===a.length&&0===e.length&&(clearInterval(n),Miniflux.Item.CheckForUpdates())}}}(),Miniflux.Item=function(){function e(e){var t=document.createEvent("MouseEvents");t.initEvent("mousedown",!0,!0),e.dispatchEvent(t),(t=document.createEvent("MouseEvents")).initEvent("mouseup",!0,!0),e.dispatchEvent(t),e.click()}function t(e){return e.getAttribute("data-item-id")}function n(e){if(0!==e.length)for(var t=0;t<e.length;t++){var n=e[t];if(n.hasAttribute("data-reverse-label")){var a=n.innerHTML;n.innerHTML=n.getAttribute("data-reverse-label"),n.setAttribute("data-reverse-label",a)}if(n.hasAttribute("data-reverse-title")){var i=n.getAttribute("title");n.setAttribute("title",n.getAttribute("data-reverse-title")),n.setAttribute("data-reverse-title",i)}}}function a(e,t){if(0!==e.length)for(var n=0;n<e.length;n++)e[n].setAttribute("data-action",t)}function i(e){n(e.querySelectorAll(".bookmark-icon, a.bookmark"))}function r(e){n(e.querySelectorAll(".read-icon, a.mark"))}function o(e){"read"!==e.getAttribute("data-item-status")&&(h--,e.getAttribute("data-hide")?c(e):(e.setAttribute("data-item-status","read"),r(e),a(e.querySelectorAll(".read-icon, a.mark"),"mark-unread")))}function u(e){"unread"!==e.getAttribute("data-item-status")&&(h++,e.getAttribute("data-hide")?c(e):(e.setAttribute("data-item-status","unread"),r(e),a(e.querySelectorAll(".read-icon, a.mark"),"mark-read")))}function c(e){if("mouse"!==Miniflux.Event.lastEventType&&"touch"!==Miniflux.Event.lastEventType){var t=document.getElementsByTagName("article");"current-item"===t[t.length-1].id?Miniflux.Nav.SelectPreviousItem():Miniflux.Nav.SelectNextItem()}e.parentNode.removeChild(e),p--}function s(){var e=null,t=document.getElementById("page-counter");t&&(t.textContent=p||""),document.getElementById("nav-counter").textContent=h||"";var n=document.querySelector("div.page-header h2:first-of-type");if(n)e=n.firstChild.nodeValue;else{var a=document.querySelector("article.item h1:first-of-type");if(a)return void(document.title=a.textContent)}switch(document.querySelector("section.page").getAttribute("data-item-page")){case"unread":document.title="Miniflux ("+h+")";break;case"feed-items":document.title="("+p+") "+e;break;default:document.title=t?e+" ("+p+")":e}}function d(e){var n=t(e),a=new XMLHttpRequest;a.onload=function(){Miniflux.Nav.IsListing()&&(o(e),s())},a.open("POST","?action=mark-item-read&id="+n,!0),a.send()}function l(e){var n=t(e),a=new XMLHttpRequest;a.onload=function(){Miniflux.Nav.IsListing()&&(u(e),s())},a.open("POST","?action=mark-item-unread&id="+n,!0),a.send()}function m(e){var n=t(e),a=new XMLHttpRequest;a.onload=function(){Miniflux.Nav.IsListing()&&(c(e),"unread"===e.getAttribute("data-item-status")&&h--,s())},a.open("POST","?action=mark-item-removed&id="+n,!0),a.send()}var f={},v=!1,h=function(){var e=document.getElementById("nav-counter");if(e)return parseInt(e.textContent,10)||0}(),p=function(){var e=document.getElementById("page-counter");if(e)return parseInt(e.textContent,10)||0}();return{MarkAsRead:d,MarkAsUnread:l,MarkAsRemoved:m,SwitchBookmark:function(e){var n=t(e),a="1"===e.getAttribute("data-item-bookmark")?"0":"1",r=new XMLHttpRequest;r.onload=function(){var t=document.querySelector("section.page");Miniflux.Nav.IsListing()&&"bookmarks"===t.getAttribute("data-item-page")?(c(e),s()):(e.setAttribute("data-item-bookmark",a),i(e))},r.open("POST","?action=bookmark&id="+n+"&value="+a,!0),r.send()},selectFirstItem:function(){p>0&&Miniflux.Nav.SelectNextItem()},SwitchStatus:function(e){var t=e.getAttribute("data-item-status");"read"===t?l(e):"unread"===t&&d(e)},Show:function(t){var n=t.querySelector("a.show");n&&e(n)},OpenOriginal:function(t){var n=t.querySelector("a.original");n&&e(n)},DownloadContent:function(e){var n=document.getElementById("download-item");if(n){n.innerHTML=" "+n.getAttribute("data-before-message"),n.className="loading-icon";var a=new XMLHttpRequest;a.onload=function(){var e=JSON.parse(a.responseText);if(n.className="",e.result){var t=document.getElementById("item-content");t&&(t.innerHTML=e.content),n.innerHTML=n.getAttribute("data-after-message")}else n.innerHTML=n.getAttribute("data-failure-message")};var i=t(e);a.open("POST","?action=download-item&id="+i,!0),a.send()}},MarkFeedAsRead:function(e){var t=new XMLHttpRequest;t.onload=function(){for(var e=document.getElementsByTagName("article"),t=0,n=e.length;t<n;t++)o(e[t]);h=this.responseText,s()},t.open("POST","?action=mark-feed-as-read&feed_id="+e,!0),t.send()},ToggleRTLMode:function(){for(var e=["#current-item h1","#item-content","#listing #current-item h2","#listing #current-item .preview","#listing #current-item .preview-full-content"],t=0;t<e.length;t++){var n=document.querySelector(e[t]);n&&(n.dir=""===n.dir?"rtl":"")}},hasNewUnread:function(){return v},CheckForUpdates:function(){if(document.hidden&&v)Miniflux.App.Log("We already have updates, no need to check again");else{var e=new XMLHttpRequest;e.onload=function(){for(var e=0===f.length,t=!1,n=JSON.parse(this.responseText),a=n.last_items_timestamps,i=0;i<a.length;i++){var r=a[i],o=r.feed_id;(!f.hasOwnProperty(o)||r.updated>f[o])&&(f[o]=r.updated,t=!0)}Miniflux.App.Log("first_run: "+e+", current_unread: "+t+", response.nbUnread: "+n.nbUnread+", nbUnreadItems: "+h),document.hidden||n.nb_unread_items===h&&!v?document.hidden&&!e&&t?(Miniflux.App.Log("New Unread! Updating pagetitle."),v=!0,document.title="↻ "+document.title):Miniflux.App.Log("No update."):(Miniflux.App.Log("Counter changed! Updating unread counter."),v=!1,h=n.nb_unread_items,s()),Miniflux.App.Log("unreadItems: "+v)},e.open("GET","?action=latest-feeds-items",!0),e.send()}}}}(),Miniflux.Nav=function(){function e(e){var t=pageYOffset+document.documentElement.clientHeight;(t-(e.offsetTop+e.offsetHeight)<0||t-e.offsetTop>document.documentElement.clientHeight)&&window.scrollTo(0,e.offsetTop-10)}function t(){var t=document.getElementsByTagName("article");if(document.getElementById("current-item")){for(var n=0,a=t.length;n<a;n++)if("current-item"===t[n].id){n+1<a&&(t[n].id="item-"+t[n].getAttribute("data-item-id"),t[n+1].id="current-item",e(t[n+1]));break}}else t[0].id="current-item",e(t[0])}function n(){var t=document.getElementsByTagName("article");if(document.getElementById("current-item")){for(var n=t.length-1;n>=0;n--)if("current-item"===t[n].id){n-1>=0&&(t[n].id="item-"+t[n].getAttribute("data-item-id"),t[n-1].id="current-item",e(t[n-1]));break}}else t[t.length-1].id="current-item",e(t[t.length-1])}function a(){return!!document.getElementById("listing")}return{OpenNextPage:function(){var e=document.getElementById("next-page");e&&e.click()},OpenPreviousPage:function(){var e=document.getElementById("previous-page");e&&e.click()},SelectNextItem:function(){var e=document.getElementById("next-item");e?e.click():a()&&t()},SelectPreviousItem:function(){var e=document.getElementById("previous-item");e?e.click():a()&&n()},ShowHelp:function(){document.getElementById("help-layer").removeAttribute("class")},CloseHelp:function(){document.getElementById("help-layer").setAttribute("class","hide")},ShowSearch:function(){document.getElementById("search-opener").setAttribute("class","hide"),document.getElementById("search-form").removeAttribute("class"),document.getElementById("form-text").focus()},ToggleMenuMore:function(){var e=document.getElementById("menu-more");e.hasAttribute("class")?e.removeAttribute("class"):e.setAttribute("class","hide")},IsListing:a}}();
Miniflux.App.Run();
