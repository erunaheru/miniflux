var Miniflux={},DEBUG=!1;Miniflux.App=function(){return{Log:function(a){DEBUG&&console.log(a)},Run:function(){Miniflux.Event.ListenKeyboardEvents(),Miniflux.Event.ListenMouseEvents(),Miniflux.Event.ListenVisibilityEvents(),Miniflux.Event.ListenTouchEvents(),this.FrontendUpdateCheck(),document.addEventListener("DOMContentLoaded",Miniflux.Item.selectFirstItem(),!1)},FrontendUpdateCheck:function(){var a=new XMLHttpRequest;a.onload=function(){var a=JSON.parse(this.responseText);a.frontend_updatecheck_interval>0?(Miniflux.App.Log("Frontend updatecheck interval in minutes: "+a.frontend_updatecheck_interval),Miniflux.Item.CheckForUpdates(),setInterval(function(){Miniflux.Item.CheckForUpdates()},60*a.frontend_updatecheck_interval*1e3)):Miniflux.App.Log("Frontend updatecheck disabled")},a.open("POST","?action=get-config",!0),a.send(JSON.stringify(["frontend_updatecheck_interval"]))}}}(),Miniflux.Event=function(){function b(a){if(63!==a.keyCode&&63!==a.which&&(a.ctrlKey||a.shiftKey||a.altKey||a.metaKey))return!0;var b=a.target||a.srcElement;return"INPUT"===b.tagName||"TEXTAREA"===b.tagName}var a=[];return{lastEventType:"",ListenMouseEvents:function(){document.onclick=function(a){a.target.hasAttribute("data-action")&&"original"!==a.target.className&&a.preventDefault()},document.onmouseup=function(a){if(2!==a.button){if("INPUT"===a.target.nodeName&&"auto-select"===a.target.className)return void a.target.select();var b=a.target.getAttribute("data-action");if(b){Miniflux.Event.lastEventType="mouse";var c=function(){for(var b=a.target;b&&b.parentNode;)if(b=b.parentNode,b.tagName&&"article"===b.tagName.toLowerCase())return b}();switch(b){case"refresh-all":Miniflux.Feed.UpdateAll(a.target.getAttribute("data-concurrent-requests"));break;case"refresh-feed":c&&Miniflux.Feed.Update(c);break;case"mark-read":c&&Miniflux.Item.MarkAsRead(c);break;case"mark-unread":c&&Miniflux.Item.MarkAsUnread(c);break;case"mark-removed":c&&Miniflux.Item.MarkAsRemoved(c);break;case"bookmark":c&&Miniflux.Item.SwitchBookmark(c);break;case"download-item":c&&Miniflux.Item.DownloadContent(c);break;case"mark-feed-read":var d=document.getElementById("listing").getAttribute("data-feed-id");Miniflux.Item.MarkFeedAsRead(d);break;case"close-help":Miniflux.Nav.CloseHelp();break;case"show-search":Miniflux.Nav.ShowSearch();break;case"toggle-menu-more":Miniflux.Nav.ToggleMenuMore()}}}}},ListenKeyboardEvents:function(){document.onkeypress=function(c){if(!b(c))if(Miniflux.Event.lastEventType="keyboard",a.push(c.key||c.which),"g"===a[0]||103===a[0])switch(a[1]){case void 0:break;case"u":case 117:window.location.href="?action=unread",a=[];break;case"b":case 98:window.location.href="?action=bookmarks",a=[];break;case"h":case 104:window.location.href="?action=history",a=[];break;case"s":case 115:window.location.href="?action=feeds",a=[];break;case"p":case 112:window.location.href="?action=config",a=[];break;default:a=[]}else{a=[];var d=function(){return document.getElementById("current-item")}();switch(c.key||c.which){case"d":case 100:d&&Miniflux.Item.DownloadContent(d);break;case"p":case 112:case"k":case 107:Miniflux.Nav.SelectPreviousItem();break;case"n":case 110:case"j":case 106:Miniflux.Nav.SelectNextItem();break;case"v":case 118:d&&Miniflux.Item.OpenOriginal(d);break;case"o":case 111:d&&Miniflux.Item.Show(d);break;case"m":case 109:d&&Miniflux.Item.SwitchStatus(d);break;case"f":case 102:d&&Miniflux.Item.SwitchBookmark(d);break;case"h":case 104:Miniflux.Nav.OpenPreviousPage();break;case"l":case 108:Miniflux.Nav.OpenNextPage();break;case"r":case 114:Miniflux.Feed.UpdateAll();break;case"?":case 63:Miniflux.Nav.ShowHelp();break;case"Q":case 81:case"q":case 113:Miniflux.Nav.CloseHelp();break;case"z":case 122:Miniflux.Item.ToggleRTLMode()}}},document.onkeydown=function(a){if(!b(a))switch(Miniflux.Event.lastEventType="keyboard",a.key||a.which){case"ArrowLeft":case"Left":case 37:Miniflux.Nav.SelectPreviousItem();break;case"ArrowRight":case"Right":case 39:Miniflux.Nav.SelectNextItem();break;case"/":case 191:a.preventDefault(),a.stopPropagation(),Miniflux.Nav.ShowSearch()}}},ListenVisibilityEvents:function(){document.addEventListener("visibilitychange",function(){Miniflux.App.Log("document.visibilityState: "+document.visibilityState),!document.hidden&&Miniflux.Item.hasNewUnread()&&(Miniflux.App.Log("Need to update the unread counter with fresh values from the database"),Miniflux.Item.CheckForUpdates())})},ListenTouchEvents:function(){var a=null,b=function(){a&&a.element&&(a.element.style.opacity=1,a.element.style.transform=""),a={touchstart:{x:-1,y:-1},touchmove:{x:-1,y:-1},touchend:!1,direction:"undetermined",swipestarted:!1,element:null}},c=function(){return a.touchstart.x>-1&&a.touchmove.x>-1&&(Math.abs(a.touchmove.x-a.touchstart.x)>30||a.swipestarted)&&Math.abs(a.touchmove.y-a.touchstart.y)<75?(a.swipestarted=!0,a.touchmove.x-a.touchstart.x):0},d=function(a,b){return a&&(b(a)?a:d(a.parentNode,b))},e=function(){return a.element?a.element:d(document.elementFromPoint(a.touchstart.x,a.touchstart.y),function(a){return"ARTICLE"===a.tagName})},f=function(){if(!a||a.touchend!==!0&&a.touchstart.x!=-1){null===a.element&&(a.element=e());var d=c();if(0!==d){var g=e();if(!g)return void b();var h=Math.abs(d);a.element.style.opacity=1-(h>75?.9:h/75*.9);var i=d>75?75:d<-75?-75:d;a.element.style.transform="translateX("+i+"px)",a.element=g}window.requestAnimationFrame(f)}},g=function(d){if("undefined"!=typeof d.touches&&d.touches.length<=1){var g=d.touches[0],h=null,i=null;switch(d.type){case"touchstart":b(),a[d.type].x=g.clientX,a[d.type].y=g.clientY,f();break;case"touchmove":a[d.type].x=g.clientX,a[d.type].y=g.clientY;break;case"touchend":a[d.type]=!0,i=e(),h=c(),h>75||h<-75?(i&&Miniflux.Item.MarkAsRead(i),i.getAttribute("data-hide")||b()):b();break;case"touchcancel":b()}}else b()};b(),document.addEventListener("touchstart",g,!1),document.addEventListener("touchmove",g,!1),document.addEventListener("touchend",g,!1),document.addEventListener("touchcancel",g,!1)}}}(),Miniflux.Feed=function(){var a=[],b=5,c=null,d=[];return{Update:function(a,b){var c=a.querySelector("span.items-count");if(c){var d=a.getAttribute("data-feed-id"),e=a.querySelector("h2:first-of-type");e.className="loading-icon";var f=new XMLHttpRequest;f.onload=function(){e.className="",a.removeAttribute("data-feed-error");var d=a.querySelector(".feed-last-checked");d&&(d.innerHTML=d.getAttribute("data-after-update"));var f=JSON.parse(this.responseText);if(f.result)c.innerHTML=f.items_count.items_unread+"/"+f.items_count.items_total;else{a.setAttribute("data-feed-error","1");var g=a.querySelector(".feed-parsing-error");g&&(g.innerHTML=f.feed.parsing_error_message)}b?b(f):Miniflux.Item.CheckForUpdates()},f.open("POST","?action=refresh-feed&feed_id="+d,!0),f.send()}},UpdateAll:function(e){d=Array.prototype.slice.call(document.querySelectorAll("article:not([data-feed-disabled])")),e&&(b=e),c=setInterval(function(){for(;d.length>0&&a.length<b;){var c=d.shift();a.push(parseInt(c.getAttribute("data-feed-id"),10)),Miniflux.Feed.Update(c,Miniflux.Feed.OnFeedUpdated)}},100)},OnFeedUpdated:function(b){var e=a.indexOf(b.feed_id);e>=0&&a.splice(e,1),0===d.length&&0===a.length&&(clearInterval(c),Miniflux.Item.CheckForUpdates())}}}(),Miniflux.Nav=function(){function a(a){var b=pageYOffset+document.documentElement.clientHeight,c=a.offsetTop+a.offsetHeight;(b-c<0||b-a.offsetTop>document.documentElement.clientHeight)&&window.scrollTo(0,a.offsetTop-10)}function b(){var b=document.getElementsByTagName("article");if(document.getElementById("current-item")){for(var c=0,d=b.length;c<d;c++)if("current-item"===b[c].id){c+1<d&&(b[c].id="item-"+b[c].getAttribute("data-item-id"),b[c+1].id="current-item",a(b[c+1]));break}}else b[0].id="current-item",a(b[0])}function c(){var b=document.getElementsByTagName("article");if(document.getElementById("current-item")){for(var c=b.length-1;c>=0;c--)if("current-item"===b[c].id){c-1>=0&&(b[c].id="item-"+b[c].getAttribute("data-item-id"),b[c-1].id="current-item",a(b[c-1]));break}}else b[b.length-1].id="current-item",a(b[b.length-1])}function d(){return!!document.getElementById("listing")}return{OpenNextPage:function(){var a=document.getElementById("next-page");a&&a.click()},OpenPreviousPage:function(){var a=document.getElementById("previous-page");a&&a.click()},SelectNextItem:function(){var a=document.getElementById("next-item");a?a.click():d()&&b()},SelectPreviousItem:function(){var a=document.getElementById("previous-item");a?a.click():d()&&c()},ShowHelp:function(){var a=document.getElementById("help-layer");a.removeAttribute("class")},CloseHelp:function(){var a=document.getElementById("help-layer");a.setAttribute("class","hide")},ShowSearch:function(){document.getElementById("search-opener").setAttribute("class","hide"),document.getElementById("search-form").removeAttribute("class"),document.getElementById("form-text").focus()},ToggleMenuMore:function(){var a=document.getElementById("menu-more");a.hasAttribute("class")?a.removeAttribute("class"):a.setAttribute("class","hide")},IsListing:d}}(),Miniflux.Item=function(){function e(a){var b=document.createEvent("MouseEvents");b.initEvent("mousedown",!0,!0),a.dispatchEvent(b),b=document.createEvent("MouseEvents"),b.initEvent("mouseup",!0,!0),a.dispatchEvent(b),a.click()}function f(a){return a.getAttribute("data-item-id")}function g(a){if(0!==a.length)for(var b=0;b<a.length;b++){var c=a[b];if(c.hasAttribute("data-reverse-label")){var d=c.innerHTML;c.innerHTML=c.getAttribute("data-reverse-label"),c.setAttribute("data-reverse-label",d)}if(c.hasAttribute("data-reverse-title")){var e=c.getAttribute("title");c.setAttribute("title",c.getAttribute("data-reverse-title")),c.setAttribute("data-reverse-title",e)}}}function h(a,b){if(0!==a.length)for(var c=0;c<a.length;c++)a[c].setAttribute("data-action",b)}function i(a){var b=a.querySelectorAll(".bookmark-icon, a.bookmark");g(b)}function j(a){var b=a.querySelectorAll(".read-icon, a.mark");g(b)}function k(a){if("read"!==a.getAttribute("data-item-status")){if(c--,a.getAttribute("data-hide"))return void m(a);a.setAttribute("data-item-status","read"),j(a);var b=a.querySelectorAll(".read-icon, a.mark");h(b,"mark-unread")}}function l(a){if("unread"!==a.getAttribute("data-item-status")){if(c++,a.getAttribute("data-hide"))return void m(a);a.setAttribute("data-item-status","unread"),j(a);var b=a.querySelectorAll(".read-icon, a.mark");h(b,"mark-read")}}function m(a){if("mouse"!==Miniflux.Event.lastEventType){var b=document.getElementsByTagName("article");"current-item"===b[b.length-1].id?Miniflux.Nav.SelectPreviousItem():Miniflux.Nav.SelectNextItem()}a.parentNode.removeChild(a),d--}function n(){var a=null;window.location.href.indexOf("nothing_to_read=1")>-1&&c>0?window.location.href="?action=unread":0===d&&window.location.reload();var b=document.getElementById("page-counter");b&&(b.textContent=d||"");var e=document.getElementById("nav-counter");e.textContent=c||"";var f=document.querySelector("div.page-header h2:first-of-type");if(f)a=f.firstChild.nodeValue;else{var g=document.querySelector("article.item h1:first-of-type");if(g)return void(document.title=g.textContent)}var h=document.querySelector("section.page");switch(h.getAttribute("data-item-page")){case"unread":document.title="Miniflux ("+c+")";break;case"feed-items":document.title="("+d+") "+a;break;default:b?document.title=a+" ("+d+")":document.title=a}}function o(a){var b=f(a),c=new XMLHttpRequest;c.onload=function(){Miniflux.Nav.IsListing()&&(k(a),n())},c.open("POST","?action=mark-item-read&id="+b,!0),c.send()}function p(a){var b=f(a),c=new XMLHttpRequest;c.onload=function(){Miniflux.Nav.IsListing()&&(l(a),n())},c.open("POST","?action=mark-item-unread&id="+b,!0),c.send()}function q(a){var b=f(a),d=new XMLHttpRequest;d.onload=function(){Miniflux.Nav.IsListing()&&(m(a),"unread"===a.getAttribute("data-item-status")&&c--,n())},d.open("POST","?action=mark-item-removed&id="+b,!0),d.send()}var a={},b=!1,c=function(){var a=document.getElementById("nav-counter");if(a)return parseInt(a.textContent,10)||0}(),d=function(){var a=document.getElementById("page-counter");if(a)return parseInt(a.textContent,10)||0}();return{MarkAsRead:o,MarkAsUnread:p,MarkAsRemoved:q,SwitchBookmark:function(a){var b=f(a),c="1"===a.getAttribute("data-item-bookmark")?"0":"1",d=new XMLHttpRequest;d.onload=function(){var b=document.querySelector("section.page");Miniflux.Nav.IsListing()&&"bookmarks"===b.getAttribute("data-item-page")?(m(a),n()):(a.setAttribute("data-item-bookmark",c),i(a))},d.open("POST","?action=bookmark&id="+b+"&value="+c,!0),d.send()},selectFirstItem:function(){d>0&&Miniflux.Nav.SelectNextItem()},SwitchStatus:function(a){var b=a.getAttribute("data-item-status");"read"===b?p(a):"unread"===b&&o(a)},Show:function(a){var b=a.querySelector("a.show");b&&e(b)},OpenOriginal:function(a){var b=a.querySelector("a.original");b&&e(b)},DownloadContent:function(a){var b=document.getElementById("download-item");if(b){b.innerHTML=" "+b.getAttribute("data-before-message"),b.className="loading-icon";var c=new XMLHttpRequest;c.onload=function(){var a=JSON.parse(c.responseText);if(b.className="",a.result){var d=document.getElementById("item-content");d&&(d.innerHTML=a.content),b.innerHTML=b.getAttribute("data-after-message")}else b.innerHTML=b.getAttribute("data-failure-message")};var d=f(a);c.open("POST","?action=download-item&id="+d,!0),c.send()}},MarkFeedAsRead:function(a){var b=new XMLHttpRequest;b.onload=function(){for(var a=document.getElementsByTagName("article"),b=0,d=a.length;b<d;b++)k(a[b]);c=this.responseText,n()},b.open("POST","?action=mark-feed-as-read&feed_id="+a,!0),b.send()},ToggleRTLMode:function(){for(var a=["#current-item h1","#item-content","#listing #current-item h2","#listing #current-item .preview","#listing #current-item .preview-full-content"],b=0;b<a.length;b++){var c=document.querySelector(a[b]);c&&(c.dir=""===c.dir?"rtl":"")}},hasNewUnread:function(){return b},CheckForUpdates:function(){if(document.hidden&&b)return void Miniflux.App.Log("We already have updates, no need to check again");var d=new XMLHttpRequest;d.onload=function(){for(var d=0===a.length,e=!1,f=JSON.parse(this.responseText),g=f.last_items_timestamps,h=0;h<g.length;h++){var i=g[h],j=i.feed_id;(!a.hasOwnProperty(j)||i.updated>a[j])&&(a[j]=i.updated,e=!0)}Miniflux.App.Log("first_run: "+d+", current_unread: "+e+", response.nbUnread: "+f.nbUnread+", nbUnreadItems: "+c),document.hidden||f.nb_unread_items===c&&!b?document.hidden&&!d&&e?(Miniflux.App.Log("New Unread! Updating pagetitle."),b=!0,document.title="↻ "+document.title):Miniflux.App.Log("No update."):(Miniflux.App.Log("Counter changed! Updating unread counter."),b=!1,c=f.nb_unread_items,n()),Miniflux.App.Log("unreadItems: "+b)},d.open("GET","?action=latest-feeds-items",!0),d.send()}}}();
Miniflux.App.Run();
